/*      Ecommerce Dataset: Exploratory Data Analysis (EDA) and Cohort Analysis in SQL
Mô tả dataset: 
1. TheLook là một trang web thương mại điện tử về quần áo. Tập dữ liệu chứa thông tin về customers, products, orders, logistics, web events , digital marketing campaigns
2. Các bảng 
+ distribution_centers -> chứa vị trí về vĩ độ và kinh độ của các thành phố ở các bang
+ event: chứa thông tin về các sự kiện diễn ra (truy cập ở nền tảng nào, truy cập qua đâu, các thông tin liên quan đến địa chỉ ip...)
+ inventory_items: các thông tin về sản phẩm trong kho 
+ orders_items: các thông tin về trạng thái đơn hàng 
+ order: chứa thông tin về đơn hàng gồm (mã khách hàng, mã đơn hàng,trạng thái, thời gian tạo)
+ products: chứa thông tin về sản phẩm 
+ users: thông tin về khách hàng 
*/

-- I. Ad-hoc tasks 
-- 1. Số lượng đơn hàng và số lượng khách hàng mỗi tháng
-- 1.1 Thống kê tổng số lượng người mua đã hoàn thành đơn hàng và số lượng đơn hàng mỗi tháng ( Từ 1/2019-4/2022)
select 
Extract(year from created_at) ||'-'|| Extract(month from created_at) as month_year,
count(order_id) as  total_order, 
count(distinct user_id) as total_user 
from bigquery-public-data.thelook_ecommerce.orders
WHERE DATE(created_at) BETWEEN '2019-01-01' AND '2022-04-30'
group by 1
order by 1
/*  -- Kết luận 
số lượng đơn hàng và số lượng khách hàng gia tăng qua từng tháng và từng năm nhưng gia tăng đột biến và các tháng cuối năm sau đó giảm mạnh vào đầu tháng năm sau 
=> nhu cầu mua sắm cuối năm tăng cao */

-- 2. Giá trị đơn hàng trung bình (AOV) và số lượng khách hàng mỗi tháng
-- Lấy ra số khách hàng khác nhau mỗi tháng, số đơn hàng 
with cte as  (select 
Extract(year from created_at) ||'-'|| Extract(month from created_at) as month_year,
count(order_id) as  total_order, 
count(distinct user_id) as total_user 
from bigquery-public-data.thelook_ecommerce.orders
WHERE DATE(created_at) BETWEEN '2019-01-01' AND '2022-04-30'
group by 1
order by 1),
--lấy ra tổng số hóa đơn cho mỗi đơn hàng mỗi tháng 
 total_each_order as (
select Extract(year from created_at) ||'-'|| Extract(month from created_at) as month_year, 
sum(sale_price) as sum
from bigquery-public-data.thelook_ecommerce.order_items
WHERE DATE(created_at) BETWEEN '2019-01-01' AND '2022-04-30'
group by 1
)
select a.month_year,a.sum/b.total_order as average_order_value,b.total_user as distinct_users 
from total_each_order as a join cte as b
on a.month_year=b.month_year
order by 1

